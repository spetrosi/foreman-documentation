[id="configuring-project-with-keycloak-authentication_{context}"]
= Configuring {Project} with {Keycloak} Authentication

Use this procedure to configure {Project} to use {Keycloak} for external authentication.

.Prerequisites

* A working installation of {Keycloak} server that uses HTTPS instead of HTTP.
* A {Keycloak} account with admin privileges.
* A realm for {Project} user accounts created in {Keycloak}.
* If the certificates or the CA are self-signed, ensure that they are added to the end-user certificate trust store.

.Configuring User Federation in the {Keycloak} Web UI

. Log in to a {Keycloak} administer account.
. At the top-left of the screen, from the drop-down menu, select the realm for {Project} user accounts.
. Click *User Federation*.
. From the *Add Provider* list, select *ldap*.
. From the *Vendor* list, select *Active Directory*.
. From the *Edit Mode* list, select *UNSYNCED*.
. In the *Username LDAP attribute* field, enter _*sAMAccountName*_.
. In the *RDN LDAP attribute* field, enter _*sAMAccountName*_.
. In the *UUID LDAP attribute* field, enter the name of LDAP attribute that is used s a unique object identified for objects in LDAP.
. In the *User Object Classes* field, enter all values of object classes from your LDAP server.
. In the *Connection URL* field, enter the connection URL of your LDAP server, for example, *ldaps://_ldap.server.example.com_:636*.
. In the *Users DN* field, enter users DN from your LDAP server.
. From the *Bind Type* list, select *simple*.
. In the *Bind DN* field, enter DN of LDAP administer user.
. In the *Bind Credential* field, enter the password of LDAP administer user.
. Optional: In the *Custom User LDAP Filter* field, enter the filter.
. Set *Enable StartTLS* to *OFF*. What's this??
. From the *Search Scope* list, select *Subtree*.
. Click the *Test Connection* and *Test Authentication* buttons to ensure that configuration works.
. Click *Save*.
. At the bottom of the screen, click *Synchronize All Users*.
Synchronization might take some time on a production system when there is no ldap filter.
. In the realm menu at the right of the screen, navigate to *Users*.
. Click *View all users* and ensure that {Keycloak} has imported users from your LDAP server.

.Registering {Project} to {Keycaloak}

. On the {Project} server, install the following packages:
+
[options="nowrap", subs="verbatim,quotes,attributes"]
----
# {package-install-project} mod_auth_openidc keycloak-httpd-client-install
----

. Register {Project} to {Keycloak} as a client:
+
[options="nowrap", subs="verbatim,quotes,attributes"]
----
# keycloak-httpd-client-install --app-name foreman-openidc \
--keycloak-server-url "https://{Keycloak-short}.com:8443" \
--keycloak-admin-username "_admin_" \
--keycloak-realm "_{Project}_Realm_" \
--keycloak-admin-realm master \
--keycloak-auth-role root-admin \
-t openidc -l /users/extlogin --force
----
+
Enter the password for the administer account when prompted.
This command creates a client for {Project} in {Keycloak}.

. To configure {Project} to use {Keycloak} as an authentication source, enter the following command:
+
[options="nowrap", subs="verbatim,quotes,attributes"]
----
# satellite-installer --foreman-keycloak true \
--foreman-keycloak-app-name "foreman-openidc" \
--foreman-keycloak-realm "_{Project}_Realm_"
----

.Configuring {Project] Client in the {Keycloak} Web UI

. In the {Keycloak} web UI, navigate to {Clients} and click the {Project} client.
. Ensure that the *Access Type* setting is set to *confidential*.
. Locate the *Valid redirect URI* field that contains one redirect URI by default.
Add a second *Valid redirect URI* in the following form: `https://{foreman-example-com}/users/extlogin`.
. Click *Save*.
. Click the *Mappers* tab and click *Create* to add an audience mapper.
. In the *Name* field, enter a name for the audience mapper.
. From the *Mapper Type* list, select *Audience*.
. From the *Included Client Audience* list, select the {Project} client.
. Click *Save*.
. Click *Create* to add a group mapper so that you can specify authorization in {Project} based on group membership.
. In the *Name* field, enter a name for the group mapper.
. From the *Mapper Type* list, select *Group Membership*.
. In the *Token Claim Name* field, enter *groups*.
. Set the *Full group path* setting to OFF.
. Click *Save*.

.Configuring OIDC Settings in the {Project} Web UI

. In the {Project} web UI, navigate to *Administer* > *Settings*, and click the *Authentication* tab.
. Locate the *Authorize login delegation* row, and in the *Value* column, set the value to *Yes*.
. Locate the *Authorize login delegation auth source user autocreate* row, and in the *Value* column,
set the value to *External*.
. Locate the *Login delegation logout URL* row, and in the *Value* column, set the value to
*https://{foreman-example-com}/users/extlogout*.
. Locate the *OIDC Algorithm* row, and in the *Value* column, set the algorithm for encoding on {Keycloak} to *RS256*.
. Locate the *OIDC Audience* row, and in the *Value* column, set the value to the client ID for {Keycloak}.
. Locate the *OIDC Issuer* row, and in the *Value* column, set the value to https://{Keycloak-short}.com:8443/auth/realms/{Project}_Realm.
. Locate the *OIDC JWKs URL* row, and in the *Value* column, set the value to https://{Keycloak-short}.com:8443auth/realms/{Project}_Realm/protocol/openid-connect/certs.
. Navigate to *Administer* > *Authentication Sources* and click *External*.
. Click *Create LDAP Authentication Source* and select the {Keycloak} server.
. Click the *Locations* tab and add locations that can use the {Keycloak} authentication source.
. Click the *Organizations* tab and add organizations that can use the {Keycloak} authentication source.
. Click *Submit*.

.Configuring Group Mapping in the {Project} Web UI

To implement the Role Based Access Control (RBAC), create groups in {Project}, assign a role to that group and then map an Active Directory group to that {Project} group.
This means that anyone in the given group in {Keycloak} will be under the corresponding {Project} group.
This example configures users of the {Project}-admin user group in the Active Directory to authenticate as users with administer privileges on {Project}.

. In the {Project} web UI, navigate to *Administer* > *User Groups*, and click the *Create User Group* button.
. In the *Name* field, enter a name for the user group.
The name should not be the same as in the Active Directory.
. Do not add users and user groups to the right-hand columns.
Click the *Roles* tab.
. Select the *Administer* check box.
. Click the *External Groups* tab.
. Click the *Add external user group* button.
. In the *Name* field, enter the name of the Active Directory group.
. From the list, select *EXTERNAL*.
